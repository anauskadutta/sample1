on:
  workflow_call:
  workflow_dispatch:
  push:
    paths: '**/get-codeql-vulnerability-details.yml'

name: Get CodeQL vulnerability details

env:
  GH_TOKEN: ${{ github.token }}
  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

permissions:
  security-events: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-alert-json.outputs.json_data }}
    steps:
    - name: checkout repo content
      uses: actions/checkout@v3 # checkout the repository content

    # - name: setup python
    #   uses: actions/setup-python@v4
    #   with:
    #     python-version: '3.x' # install the python version needed

    # - name: install python packages
    #   run: |
    #     python -m pip install --upgrade pip
    #     pip install requests
    
    # - name: Execute python script
    #   id: get-alert-json
    #   run: |
    #     output=$(python ./.github/scripts/jira-issue.py)
    #     echo "json_data=${output}" >> $GITHUB_OUTPUT

    # - name: Testing python script
    #   run: echo ${{ steps.get-alert-json.outputs.json_data }}

  create:
    needs: build
    if: ${{ needs.build.outputs.matrix['details'] != '' && toJSON(fromJSON(needs.build.outputs.matrix['details'])) != '[]' }}
    # uses: ./.github/workflows/create-jira-issue.yml
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.build.outputs.matrix) }}
      # matrix:
      #   include: [{"id": 17,"name": "This variable is not accessed anywhere.","url": "https://github.com/anauskadutta/sample1/security/code-scanning/17"},{"id": 16,"name": "This variable is null.","url": "https://github.com/anauskadutta/sample1/security/code-scanning/16"}]
      fail-fast: true
    steps:
      - name: testing matrix
        run: |
          echo ${{ matrix['details'].id }}
          echo ${{ matrix['details'].name }}
          echo ${{ matrix['details'].url }}
          
    # with:
    #   project: STP
    #   codeql_alert_id: ${{ matrix['include'].id }}
    #   codeql_alert_name: ${{ matrix['include'].name }}
    #   codeql_alert_url: ${{ matrix['include'].url }}
    # secrets: inherit
